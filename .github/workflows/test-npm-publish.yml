name: Test npm Publish

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  test_npm:
    name: Test npm publish
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for OIDC/npm provenance
    steps:
      - run: npm whoami

      - name: Checkout Repo
        uses: actions/checkout@v6

      - name: Unshallow clone for tags
        run: git fetch --prune --unshallow --tags

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20.x

      - name: Install Go
        uses: actions/setup-go@v6
        with:
          go-version: 1.24.x

      - name: Install pulumictl
        uses: jaxxstorm/action-install-gh-release@v2.1.0
        with:
          repo: pulumi/pulumictl

      - name: Install pulumi
        uses: pulumi/actions@v6

      - name: Build nodejs SDK
        run: make build_nodejs

      - name: Determine npm tag
        id: npm-tag
        run: |
          VERSION=$(node -p "require('${{github.workspace}}/sdk/nodejs/bin/package.json').version")
          if [[ "$VERSION" == *-* ]]; then
            # Prerelease version (contains hyphen) - extract prerelease tag
            # e.g., 3.7.0-dev -> dev, 3.7.0-alpha.1 -> alpha, 3.7.0-beta.2 -> beta
            TAG=$(echo "$VERSION" | sed -n 's/.*-\([^.]*\).*/\1/p')
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "Publishing prerelease version $VERSION with tag: $TAG"
          else
            # Stable version - use latest
            echo "tag=latest" >> $GITHUB_OUTPUT
            echo "Publishing stable version $VERSION with tag: latest"
          fi

      - name: Publish to npm
        uses: JS-DevTools/npm-publish@v4
        with:
          access: "public"
          package: ${{github.workspace}}/sdk/nodejs/bin/package.json
          tag: ${{ steps.npm-tag.outputs.tag }}
          provenance: true  # Enable npm provenance with OIDC
          check-version: true  # Skip publishing if version already exists on npm
